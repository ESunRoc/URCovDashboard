---
title: "Improved COVID-19 Dashboard for the UofR"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    source_code: embed
runtime: shiny
---

```{r global, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(tidyverse)
library(zoo)
library(RcppRoll)
library(gridExtra)
library(grid)
library(plotly)
library(htmlwidgets)

data <- read_xlsx("covdata.xlsx")

data$daily.prate <- ifelse(data$Tests == 0, 0, data$Positive/data$Tests)
data$totcases <- cumsum(data$Positive)
data$tottests <- cumsum(data$Tests)

data$rolltests <- rollmean(data$Tests, k=7, fill=F, align="right")
data$rollpos <- rollmean(data$Positive, k=7, fill=F, align="right")
data$rolldaily.prate <- rollmean(data$daily.prate, k=7, fill=NA, align="right")

n.colfunc <- function(df, n=7, func){
  aggregate(x = df,
            by = list(gl(ceiling(nrow(df)/n), n)[1:nrow(df)]),
            FUN = func)
}

twoweeksavg <- n.colfunc(data[2:4], 14, mean)
oneweekavg <- n.colfunc(data[2:4], 7, mean)

twoweekssum <- n.colfunc(data[2:4], 14, sum)
oneweeksum <- n.colfunc(data[2:4], 7, sum)

cumlcases <- ggplot(data, aes(x = Date, y = totcases)) +
              geom_line() +
              scale_y_continuous(breaks=seq(0, max(data$totcases)+5 ,5)) +  
              labs(x = "Date", y = "Total Cases (to date)", title = "Cumulative cases as a function of time")
cc <- ggplotly(cumlcases)


GAM.cumlcases <- ggplot(data, aes(x = Date, y = totcases)) +
                  geom_smooth(method = "gam", size = 1) +
                  scale_y_continuous(breaks=seq(0, max(data$totcases)+5 ,5)) + 
                  labs(x = "Date", y = "Total Cases (to date)", title = "Cumulative cases as a function of time")
GAM.cc <- ggplotly(GAM.cumlcases)


cumltests <- ggplot(data, aes(x = Date, y = tottests)) +
              geom_line() +
              labs(x = "Date", y = "Number of Tests", title = "Cumulative Testing as a function of time")
ct <- ggplotly(cumltests)


GAM.cumltests <- ggplot(data, aes(x = Date, y = tottests)) +
                  geom_smooth(method = "gam", size = 1) +
                  labs(x = "Date", y="Number of Tests", title = "Cumulative Testing as a function of time")
GAM.ct <- ggplotly(GAM.cumltests)


dailyposrate <- ggplot(data, aes(x = Date, y = daily.prate)) +
                geom_line() + 
                labs(x = "Date", y = "Positivity Rate", title = "Daily positivity rate",
                     subtitle = "Aligned right")
dpr <- ggplotly(dailyposrate)


GAM.dailyposrate <- ggplot(data, aes(x = Date, y = daily.prate)) +
                    geom_smooth(method = "gam", size = 1) + 
                    labs(x = "Date", y = "Positivity Rate", title = "Daily positivity rate",
                         subtitle = "Aligned right")
GAM.dpr <- ggplotly(GAM.dailyposrate)


rollposrate <- ggplot(data, aes(x = Date, y = rolldaily.prate)) +
                geom_line() + 
                labs(x = "Date", y = "Positivity Rate", title = "7 day rolling positivity rate",
                     subtitle = "Aligned right")
rpr <- ggplotly(rollposrate)


GAM.rollposrate <- ggplot(data, aes(x = Date, y = rolldaily.prate)) +
                    geom_smooth(method = "gam", size = 1) + 
                    labs(x = "Date", y = "Positivity Rate", title = "7 day rolling positivity rate",
                         subtitle = "Aligned right")
GAM.rpr <- ggplotly(GAM.rollposrate)


rolltestsgraph <- ggplot(data, aes(x=Date, y=rolltests)) + 
                    geom_line()+
                    labs(x="Date", y="Tests Conducted", title = "7 day rolling tests per day",
                         subtitle = "Aligned Right")
rtg <- ggplotly(rolltestsgraph)


GAM.rolltestsgraph <- ggplot(data, aes(x=Date, y=rolltests)) + 
                        geom_smooth(method = "gam", size = 1) +
                        labs(x="Date", y="Tests Conducted", title = "7 day rolling tests per day",
                             subtitle = "Aligned Right")
GAM.rtg <- ggplotly(GAM.rolltestsgraph)


casesperday <- ggplot(data, aes(x=Date, y=Positive)) + 
                geom_line()+
                labs(x = "Date", y = "Cases", title = "New cases per day")
cpd <- ggplotly(casesperday)


GAM.casesperday <- ggplot(data, aes(x=Date, y=Positive)) + 
                    geom_smooth()+
                    labs(x = "Date", y = "Cases", title = "New cases per day")
GAM.cpd <- ggplotly(GAM.casesperday)


testsperday <- ggplot(data, aes(x=Date, y=Tests)) + 
                geom_line()+
                labs(x = "Date", y = "Tests", title = "Tests per day")
tpd <- ggplotly(testsperday)


GAM.testsperday <- ggplot(data, aes(x=Date, y=Tests)) + 
                    geom_smooth(method = "gam", size=1)+
                    labs(x = "Date", y = "Tests", title = "Tests per day")
GAM.tpd <- ggplotly(GAM.testsperday)


oneweek.avgtests <- ggplot(oneweekavg, aes(x=Group.1, y=Tests, group=1)) +
                      geom_line() + 
                      labs(x="Weeks since August 1", title="Average Tests Over Time Period", 
                           subtitle = "Temporal mean, t=7")
owat <- ggplotly(oneweek.avgtests)


twoweeks.avgtests <- ggplot(twoweeksavg, aes(x=Group.1, y=Tests, group=1)) +
                      geom_line() + 
                      labs(x="Fortnights since August 1", title="Average Tests Over Time Period", 
                           subtitle = "Temporal mean, t=14")
twsat <- ggplotly(twoweeks.avgtests)


oneweek.sumtests <- ggplot(oneweeksum, aes(x=Group.1, y=Tests, group=1)) +
                      geom_line() + 
                      labs(x="Weeks since August 1", title="Cumulative Tests Time Period")
owst <- ggplotly(oneweek.sumtests)

  
twoweeks.sumtests <- ggplot(twoweekssum, aes(x=Group.1, y=Tests, group=1)) +
                      geom_line() + 
                      labs(x="Fortnights since August 1", title="Cumulative Tests Time Period")
twst <- ggplotly(twoweeks.sumtests)
```

Total Cases {data-navmenu="Cases"}
=====================================  
    
Inputs {.sidebar}
-----------------------------------------------------------------------

The total number of cases as a function of time.  
These graphs show more or less what we expect to see; over time, as more tests are conducted, we do expect to see more cases. Ultimately what we'd like to be seeing is a plateau, but given the rates at which cases are spiking all over the country, expecting that of UR is probably unfair.  
  

**Date:**  
`r  data[nrow(data),1]`  
**Cases in past 24 hours:**  
`r data[nrow(data), 3]`  
**Tests in past 24 hours:**  
`r data[nrow(data), 2]`  
**Positivity Rate in Past 24 Hours:**  
`r data[nrow(data), 4]*100`\%  

Row
-----------------------------------------------------------------------

### Raw lineplot

```{r}
cc
```


Row 
-----------------------------------------------------------------------

### Smoothed with a GAM

```{r}
GAM.cc
```

Total Testing {data-navmenu="Testing"}
=====================================  
Inputs {.sidebar}
-----------------------------------------------------------------------


Total tests conducted. Again, this is more or less what we expect to see. Over time, the number of total tests conducted (assuming they don't simply *stop* testing people) will continue to increase without limit. What is the rate of this increase (explored in greater detail via other charts). To highlight here are August 16-17, where the first glut of students began to arrive back on campus, and November 16-17, when the University began use of the so-called "Rapid" tests. The true reliability rate of these latter tests is unknown, especially when used on asymptomatic persons, so while I would like to be able to distinguish between the types of tests used, this is made *very* difficult by the lack of test-specific data from the university.  

**Date:**  
`r  data[nrow(data),1]`  
**Cases in past 24 hours:**  
`r data[nrow(data), 3]`  
**Tests in past 24 hours:**  
`r data[nrow(data), 2]`  
**Positivity Rate in Past 24 Hours:**  
`r data[nrow(data), 4]*100`\%  

Row
-----------------------------------------------------------------------

### Raw lineplot

```{r}
ct
```


Row 
-----------------------------------------------------------------------

### Smoothed with a GAM

```{r}
GAM.ct
```

Daily (+) Rate {data-navmenu="Positivity Rates"}
=====================================  
Inputs {.sidebar}
-----------------------------------------------------------------------

Daily positivity rate. This is perhaps the most important statistic that can be provided when talking about COVID-19 in general terms. Why? Well, because it's a standardized metric. Positivity rate is simply the number of positive tests divided by the number of tests conducted. Therefore, a state like ND, that may only conduct 10-15,000 tests per day, can be directly equated to, say, CA, which may conduct 100-200,000 tests per day. And here it is where we see the UofR is being less-than-transparent. These numbers don't look great for them. They'd look much better if more people were tested, however. This is because, primarily, of a handful of days where testing was in the single digits but a single digit number of cases was also found. In reality this is likely not representative of the true population, but since the true population size is unknown, we can't actually say this and thus, cannot actually say it's definitely a statistical outlier.

**Date:**  
`r  data[nrow(data),1]`  
**Cases in past 24 hours:**  
`r data[nrow(data), 3]`  
**Tests in past 24 hours:**  
`r data[nrow(data), 2]`  
**Positivity Rate in Past 24 Hours:**  
`r data[nrow(data), 4]*100`\%  

Row
-----------------------------------------------------------------------

### Raw lineplot

```{r}
dpr
```


Row 
-----------------------------------------------------------------------

### Smoothed with a GAM

```{r}
GAM.dpr
```


Rolling (+) Rate {data-navmenu="Positivity Rates"}
=====================================  
Inputs {.sidebar}
-----------------------------------------------------------------------
  
  ```{r}

```

sidebar on page 2

Row
-----------------------------------------------------------------------

### Raw lineplot

```{r}
rpr
```


Row 
-----------------------------------------------------------------------

### Smoothed with a GAM

```{r}
GAM.rpr
```


Rolling tests/day {data-navmenu="Testing"}
=====================================  
Inputs {.sidebar}
-----------------------------------------------------------------------
  
  ```{r}

```

sidebar on page 2

Row
-----------------------------------------------------------------------

### Raw lineplot

```{r}
rtg
```


Row 
-----------------------------------------------------------------------

### Smoothed with a GAM

```{r}
GAM.rtg
```


Cases per day {data-navmenu="Cases"}
=====================================  
Inputs {.sidebar}
-----------------------------------------------------------------------
  
  ```{r}

```

sidebar on page 2

Row
-----------------------------------------------------------------------

### Raw lineplot

```{r}
cpd
```


Row 
-----------------------------------------------------------------------

### Smoothed with a GAM

```{r}
GAM.cpd
```


Tests per day {data-navmenu="Testing"}
=====================================  
Inputs {.sidebar}
-----------------------------------------------------------------------
  
  ```{r}

```

sidebar on page 2

Row
-----------------------------------------------------------------------

### Raw lineplot

```{r}
tpd
```


Row 
-----------------------------------------------------------------------

### Smoothed with a GAM

```{r}
GAM.tpd
```


Average Tests per Unit Time {data-navmenu="Testing"}
=====================================  
Inputs {.sidebar}
-----------------------------------------------------------------------
  
  ```{r}

```

sidebar on page 2

Row
-----------------------------------------------------------------------

### 7 day blocs

```{r}
owat
```


Row 
-----------------------------------------------------------------------

### 14 day blocs

```{r}
twsat
```



Total Tests per Unit Time {data-navmenu="Testing"}
=====================================  
Inputs {.sidebar}
-----------------------------------------------------------------------
  
  ```{r}

```

sidebar on page 2

Row
-----------------------------------------------------------------------

### 7 day blocs

```{r}
owst
```


Row 
-----------------------------------------------------------------------

### 14 day blocs

```{r}
twst
```

